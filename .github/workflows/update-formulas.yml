name: Update Formulas

on:
  schedule:
    # Run weekly on Mondays at 9:00 UTC
    - cron: "0 9 * * 1"
  workflow_dispatch:
    inputs:
      formula:
        description: "Specific formula to update (leave empty for all)"
        required: false
        type: string
      dry_run:
        description: "Dry run (check only, no PR)"
        required: false
        type: boolean
        default: false

jobs:
  check-updates:
    name: Check for updates
    runs-on: ubuntu-latest
    outputs:
      updates: ${{ steps.check.outputs.updates }}
      has_updates: ${{ steps.check.outputs.has_updates }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: pip install requests packaging

      - name: Check for formula updates
        id: check
        run: |
          python scripts/check_updates.py \
            ${{ inputs.formula && format('--formula {0}', inputs.formula) || '' }} \
            --output-json updates.json

          if [ -f updates.json ]; then
            updates=$(cat updates.json)
            echo "updates=$updates" >> $GITHUB_OUTPUT

            # Check if there are any updates
            count=$(echo "$updates" | python -c "import sys, json; print(len(json.load(sys.stdin)))")
            if [ "$count" -gt 0 ]; then
              echo "has_updates=true" >> $GITHUB_OUTPUT
              echo "Found $count formula(s) with updates available"
            else
              echo "has_updates=false" >> $GITHUB_OUTPUT
              echo "All formulas are up to date"
            fi
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "updates=[]" >> $GITHUB_OUTPUT
          fi

  update-formulas:
    name: Update formulas
    runs-on: ubuntu-latest
    needs: check-updates
    if: needs.check-updates.outputs.has_updates == 'true' && inputs.dry_run != true
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: pip install requests packaging

      - name: Update formulas
        run: |
          echo '${{ needs.check-updates.outputs.updates }}' > updates.json
          python scripts/update_formulas.py --updates-file updates.json

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update formula versions"
          title: "chore: update formula versions"
          body: |
            Automated formula version updates.

            Updates:
            ${{ needs.check-updates.outputs.updates }}

            ---
            *This PR was automatically created by the update-formulas workflow.*
          branch: auto-update/formulas
          delete-branch: true
