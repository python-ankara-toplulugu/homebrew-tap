name: Update Formulas
on:
  schedule:
    # Run weekly on Mondays at 9:00 UTC
    - cron: "0 9 * * 1"
  workflow_dispatch:
    inputs:
      formula:
        description: "Specific formula to update (leave empty for all)"
        required: false
        type: string
      dry_run:
        description: "Dry run (check only, no PR)"
        required: false
        type: boolean
        default: false
jobs:
  check-updates:
    timeout-minutes: 10
    name: Check for updates
    runs-on: ubuntu-latest
    outputs:
      updates: ${{ steps.check.outputs.updates }}
      has_updates: ${{ steps.check.outputs.has_updates }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v4
      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@master
      - name: Tap this repository
        run: |
          brew tap ${{ github.repository }} "$(pwd)"
      - name: Check for formula updates
        id: check
        run: |
          # Get list of formulas to check
          if [ -n "${{ inputs.formula }}" ]; then
            formulas="${{ inputs.formula }}"
          else
            formulas=$(find Formula -name '*.rb' -exec basename {} .rb \; | tr '\n' ' ')
          fi

          echo "Checking formulas: $formulas"

          # Use brew livecheck to check for updates
          updates_json="[]"
          has_updates="false"

          for formula in $formulas; do
            echo "Checking $formula..."

            # Run livecheck and capture output
            livecheck_output=$(brew livecheck --json "${{ github.repository_owner }}/$(basename "${{ github.repository }}")/${formula}" 2>/dev/null || echo "[]")

            # Check if there's an update (version.outdated == true)
            is_outdated=$(echo "$livecheck_output" | jq -r '.[0].version.outdated // false')

            if [ "$is_outdated" = "true" ]; then
              current=$(echo "$livecheck_output" | jq -r '.[0].version.current')
              latest=$(echo "$livecheck_output" | jq -r '.[0].version.latest')
              echo "  Update available: $current -> $latest"

              # Add to updates array
              updates_json=$(echo "$updates_json" | jq --arg f "$formula" --arg c "$current" --arg l "$latest" \
                '. + [{"formula": $f, "current_version": $c, "latest_version": $l}]')
              has_updates="true"
            else
              echo "  Up to date"
            fi
          done

          echo "updates=$updates_json" >> "$GITHUB_OUTPUT"
          echo "has_updates=$has_updates" >> "$GITHUB_OUTPUT"
  update-formulas:
    timeout-minutes: 20
    name: Update formulas
    runs-on: ubuntu-latest
    needs: check-updates
    if: needs.check-updates.outputs.has_updates == 'true' && inputs.dry_run != true
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v4
      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@master
      - name: Tap this repository
        run: |
          brew tap ${{ github.repository }} "$(pwd)"
      - name: Update formulas
        run: |
          updates='${{ needs.check-updates.outputs.updates }}'

          echo "$updates" | jq -c '.[]' | while read -r update; do
            formula=$(echo "$update" | jq -r '.formula')
            latest=$(echo "$update" | jq -r '.latest_version')

            echo "Updating $formula to $latest..."

            # Use brew bump-formula-pr to update the formula (without creating PR)
            # This updates URL, sha256, and can update resources
            brew bump-formula-pr \
              --no-audit \
              --no-browse \
              --write-only \
              --version="$latest" \
              "${{ github.repository_owner }}/$(basename "${{ github.repository }}")/${formula}"

            # Update Python resources (may fail for non-Python packages)
            brew update-python-resources \
              "${{ github.repository_owner }}/$(basename "${{ github.repository }}")/${formula}" \
              || echo "Note: update-python-resources failed for $formula (may not be a Python package)"
          done
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@c0f553fe549906ede9cf27b5156039d195d2ece0 # v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update formula versions"
          title: "chore: update formula versions"
          body: |
            Automated formula version updates.

            Updates:
            ```json
            ${{ needs.check-updates.outputs.updates }}
            ```

            ---
            *This PR was automatically created by the update-formulas workflow.*
          branch: auto-update/formulas
          delete-branch: true
