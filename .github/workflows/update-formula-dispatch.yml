name: Update Formula (Dispatch)
# Triggered by package repos after PyPI publish
on:
  repository_dispatch:
    types: [update-formula]
# Expected payload:
# {
#   "formula": "ossin",           # Formula name (required)
#   "version": "0.2.0"            # New version (optional, will check PyPI if not provided)
# }
jobs:
  update:
    timeout-minutes: 20
    name: Update ${{ github.event.client_payload.formula }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v4
      - name: Validate payload
        run: |
          if [ -z "${{ github.event.client_payload.formula }}" ]; then
            echo "Error: 'formula' is required in client_payload"
            exit 1
          fi

          formula="${{ github.event.client_payload.formula }}"
          if [ ! -f "Formula/${formula}.rb" ]; then
            echo "Error: Formula '${formula}' not found"
            exit 1
          fi

          echo "Updating formula: ${formula}"
      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@master
      - name: Tap this repository
        run: |
          brew tap ${{ github.repository }} "$(pwd)"
      - name: Check for update
        id: check
        run: |
          formula="${{ github.event.client_payload.formula }}"
          provided_version="${{ github.event.client_payload.version }}"
          tap_name="${{ github.repository_owner }}/$(basename "${{ github.repository }}")"

          if [ -n "$provided_version" ]; then
            # Version provided in payload, use it directly
            echo "version=$provided_version" >> "$GITHUB_OUTPUT"
            echo "has_update=true" >> "$GITHUB_OUTPUT"
            echo "Using provided version: $provided_version"
          else
            # Use livecheck to find the latest version
            livecheck_output=$(brew livecheck --json "${tap_name}/${formula}" 2>/dev/null || echo "[]")
            is_outdated=$(echo "$livecheck_output" | jq -r '.[0].version.outdated // false')

            if [ "$is_outdated" = "true" ]; then
              latest=$(echo "$livecheck_output" | jq -r '.[0].version.latest')
              echo "version=$latest" >> "$GITHUB_OUTPUT"
              echo "has_update=true" >> "$GITHUB_OUTPUT"
              echo "Found update: $latest"
            else
              echo "has_update=false" >> "$GITHUB_OUTPUT"
              echo "Formula is already up to date"
            fi
          fi
      - name: Update formula
        if: steps.check.outputs.has_update == 'true'
        run: |
          formula="${{ github.event.client_payload.formula }}"
          version="${{ steps.check.outputs.version }}"
          tap_name="${{ github.repository_owner }}/$(basename "${{ github.repository }}")"

          echo "Updating $formula to $version..."

          # Use brew bump-formula-pr to update the formula (without creating PR)
          brew bump-formula-pr \
            --no-audit \
            --no-browse \
            --write-only \
            --version="$version" \
            "${tap_name}/${formula}"

          # Update Python resources (may fail for non-Python packages)
          brew update-python-resources "${tap_name}/${formula}" \
            || echo "Note: update-python-resources failed for $formula (may not be a Python package)"
      - name: Create Pull Request
        if: steps.check.outputs.has_update == 'true'
        uses: peter-evans/create-pull-request@c0f553fe549906ede9cf27b5156039d195d2ece0 # v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(${{ github.event.client_payload.formula }}): update to ${{ steps.check.outputs.version }}"
          title: "chore(${{ github.event.client_payload.formula }}): update to ${{ steps.check.outputs.version }}"
          body: |
            Automated update triggered by package release.

            - **Formula**: `${{ github.event.client_payload.formula }}`
            - **Version**: `${{ steps.check.outputs.version }}`

            ---
            *Triggered by repository_dispatch from package repo.*
          branch: auto-update/${{ github.event.client_payload.formula }}
          delete-branch: true
